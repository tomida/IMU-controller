<!doctype html>
<!--
Copyright 2019 Yu Tomida. All Rights Reserved.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="GAIT">
    <meta name="viewport" content="width=800, maximum-scale=1.0, user-scalable=yes">
    <title>GAIT</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="bluejelly.js"></script>
  </head>

<body>
<div class="container">
    <div class="title margin">
        <p id="title">IMU Controller</p>
    </div>

    <div class="contents margin">
        <button id="connect" class="button">Connect</button>
        <button id="startNotifications" class="button">Start Notify</button>
        <button id="reset" class="button">Reset</button>
        <button id="start" class="button">Start</button>
        <button id="calc" class="button">Calc</button>
        <hr>
        <div id="device_name"> </div>
        <div id="uuid_name"> </div>
        <div id="data_text"> </div>
        <div id="status"> </div>
        <select id="parameter">
          <option value="size">size</option>
          <option value="acc_th">acc_th</option>
          <option value="init_period">init_period</option>
        </select>
        <button id="get" class="button">Get</button>
        <input id='_value' type='number' value='1' size="4">
        <button id="set" class="button">Set</button>
        <br>
        <select id="download option">
          <option value="imu">IMU</option>
          <option value="gyr">Gyro</option>
          <option value="flt">Filtered</option>
          <option value="pos">Position</option>
          <option value="quat">Quaternion</option>
          <option value="euler">Euler</option>
        </select>
        <button id="download" class="button">Download</button>

    </div>
    <div class="footer margin">
      For more information, see <a href="https://github.com/tomida/imu-controller" target="_blank">GitHub</a>!
    </div>
</div>
<script>
//--------------------------------------------------
//global variable
//--------------------------------------------------
//generate an instance
var ble = new BlueJelly();
// read data
var read_data = ''

//--------------------------------------------------
//after loading
//--------------------------------------------------
window.onload = function () {
  //initial messages
  document.getElementById('device_name').innerHTML  = "No Device";
  document.getElementById('uuid_name').innerHTML    = "Not Connected";
  document.getElementById('status').innerHTML       = "ready";

  //UUID settings
  // ble.setUUID("UUID1", "d68c0001-a21b-11e5-8cb8-0002a5d5c51b", "d68c0002-a21b-11e5-8cb8-0002a5d5c51b");  // Service and Indicate
  // ble.setUUID("UUID2", "d68c0001-a21b-11e5-8cb8-0002a5d5c51b", "d68c0003-a21b-11e5-8cb8-0002a5d5c51b");  // Service and Write
}


//--------------------------------------------------
//after scanning
//--------------------------------------------------
ble.onScan = function (deviceName) {
  console.log('> Bluetooth Device found!');

  document.getElementById('device_name').innerHTML = deviceName;
  document.getElementById('status').innerHTML = "found device!";
}


//--------------------------------------------------
//after connectGATT
//--------------------------------------------------
ble.onConnectGATT = function (uuid) {
  console.log('> connected GATT!');

  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "connected GATT!";
}


//--------------------------------------------------
//when disconnected
//--------------------------------------------------
ble.onDisconnect = function() {
  document.getElementById('uuid_name').innerHTML = "Not Connected";
  document.getElementById('status').innerHTML = "disconnected";
}


//--------------------------------------------------
//when cleared
//--------------------------------------------------
ble.onClear = function() {
  document.getElementById('device_name').innerHTML = "No Device";
  document.getElementById('status').innerHTML = "cleared";
}


//--------------------------------------------------
//after reset
//--------------------------------------------------
ble.onReset = function() {
  document.getElementById('device_name').innerHTML = "No Device";
  document.getElementById('uuid_name').innerHTML = "Not Connected";
  document.getElementById('status').innerHTML = "cleared";
}

//--------------------------------------------------
//after error
//--------------------------------------------------
ble.onError = function(error){
  document.getElementById('status').innerHTML = "ERROR : " + error;
}

//--------------------------------------------------
//after writing
//--------------------------------------------------
ble.onWrite = function(uuid){
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "written data"
}

//--------------------------------------------------
//after reading
//--------------------------------------------------
ble.onRead = function (data, uuid){
  //decode data from a device
  decoded_data = (new TextDecoder('utf-8')).decode(data)
  //display the value in console
  console.log(decoded_data);
  read_data += decoded_data
  if(read_data.match("OK") && read_data.match(":") ){
// todo ã€€file download
    read_data=''
  }
  else if(read_data.match("OK") || read_data.match("ERROR")){  //display the value in html
    document.getElementById('data_text').innerHTML = read_data.replace("OK", "");
    read_data=''
  }
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "read data"
}


//-------------------------------------------------
//Event listener when buttons are clicked
//--------------------------------------------------
document.getElementById('connect').addEventListener('click', function() {
  onButtonClick();
});

document.getElementById('startNotifications').addEventListener('click', function() {
    ble.startNotify('[INDICATE]');
});

document.getElementById('reset').addEventListener('click', function() {
    ble.reset(); //reset is disconnect & clear
});
//start
document.getElementById('start').addEventListener('click', function() {
    data = new TextEncoder("utf-8").encode('start\n');
    ble.write('[WRITE]', data);
});
// calc
document.getElementById('calc').addEventListener('click', function() {
    data = new TextEncoder("utf-8").encode('calc\n');
    ble.write('[WRITE]', data);
});
// get parameter settings
document.getElementById('get').addEventListener('click', function() {
    option = document.getElementById('parameter').value;
    console.log(`get ${option}\n`)
    data = new TextEncoder("utf-8").encode(`get ${option}\n`);
    ble.write('[WRITE]', data);
});

// set parameter
document.getElementById('set').addEventListener('click', function() {
    param = document.getElementById('parameter').value;
    _value = document.getElementById('_value').value;
    console.log(`set ${param} ${_value}\n`)
    data = new TextEncoder("utf-8").encode(`set ${param} ${_value}\n`);
    ble.write('[WRITE]', data);
});

// download
document.getElementById('download').addEventListener('click', function() {
    option = document.getElementById('download option').value;
    console.log(`download ${option}\n`)
    data = new TextEncoder("utf-8").encode(`download ${option}\n`);
    ble.write('[WRITE]', data);
});

const onButtonClick = () => {
  // Validate services UUID entered by user first.
  let optionalServices = 'generic_access'
    .split(/, ?/).map(s => s.startsWith('0x') ? parseInt(s) : s)
    .filter(s => s && BluetoothUUID.getService);

  console.log('Requesting any Bluetooth Device...');
  navigator.bluetooth.requestDevice({
   // filters: [...] <- Prefer filters to save energy & show relevant devices.
      acceptAllDevices: true,
      optionalServices: optionalServices})
  .then(device => {
    console.log('Connecting to GATT Server...');
    return device.gatt.connect();
  })
  .then(server => {
    // Note that we could also get all services that match a specific UUID by
    // passing it to getPrimaryServices().
    console.log('Getting Services...');
    return server.getPrimaryServices();
  })
  .then(services => {
    console.log('Getting Characteristics...');
    let queue = Promise.resolve();
    services.forEach(service => {
      queue = queue.then(_ => service.getCharacteristics().then(characteristics => {
        console.log('> Service: ' + service.uuid);
        characteristics.forEach(characteristic => {
          console.log('>> Characteristic: ' + characteristic.uuid + ' ' +
              getSupportedProperties(characteristic));
              ble.setUUID(getSupportedProperties(characteristic), service.uuid, characteristic.uuid);
        });
      }));
    });
    return queue;
  })
  .catch(error => {
    console.log('Argh! ' + error);
  });
}

/* Utils */

const getSupportedProperties = (characteristic) => {
  let supportedProperties = [];
  for (const p in characteristic.properties) {
    if (characteristic.properties[p] === true) {
      supportedProperties.push(p.toUpperCase());
    }
  }
  return '[' + supportedProperties.join(', ') + ']';
}

</script>
</body>
</html>
