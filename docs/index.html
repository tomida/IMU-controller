<!doctype html>
<!--
Copyright 2019 Yu Tomida. All Rights Reserved.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="GAIT">
    <meta name="viewport" content="width=800, maximum-scale=1.0, user-scalable=yes">
    <title>GAIT</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="bluejelly.js"></script>
  </head>

<body>
<div class="container">
    <div class="title margin">
        <p id="title">IMU Controller</p>
    </div>
    <div class="contents margin">
      <button id="start_all" class="button">Start All</button>
      <button id="calc_all" class="button">Calc All</button>
    </div>
    <hr>
    <div class="contents margin">
        <!-- Push 'Get UUID'  before 'start Notify'<br>
        <button id="getUUID" class="button">Get UUID</button> -->
        <button id="startNotifications" class="button">Notify/Reset</button>
        <!-- <button id="reset" class="button">Reset</button> -->
        <button id="start" class="button">Start</button>
        <button id="calc" class="button">Calc</button>
        <div id="device_name"> </div>
        <div id="uuid_name"> </div>
        <div id="data_text"> </div>
        <div id="status"> </div>
        <select id="parameter" class="button">
          <option value="size">size</option>
          <option value="acc_th">acc_th</option>
          <option value="init_period">init_period</option>
        </select>
        <button id="get" class="button">Get</button>
        <input id='_value' type='number' class="button" value='1' size="4">
        <button id="set" class="button">Set</button>
        <br>
        <select id="download_option" class="button">
          <option value="imu">IMU</option>
          <option value="gyr">Gyro</option>
          <option value="flt">Filtered</option>
          <option value="pos">Position</option>
          <option value="quat">Quaternion</option>
          <option value="euler">Euler</option>
        </select>
        <button id="download" class="button">Download</button>

    </div>
    <hr>
    <div class="contents margin">
        <!-- Push 'Get UUID'  before 'start Notify'<br>
        <button id="getUUID2" class="button">Get UUID</button> -->
        <button id="startNotifications2" class="button">Notify/Reset</button>
        <!-- <button id="reset2" class="button">Reset</button> -->
        <button id="start2" class="button">Start</button>
        <button id="calc2" class="button">Calc</button>
        <div id="device_name2"> </div>
        <div id="uuid_name2"> </div>
        <div id="data_text2"> </div>
        <div id="status2"> </div>
        <select id="parameter2" class="button">
          <option value="size">size</option>
          <option value="acc_th">acc_th</option>
          <option value="init_period">init_period</option>
        </select>
        <button id="get2" class="button">Get</button>
        <input id='_value2' type='number' class="button" value='1' size="4">
        <button id="set2" class="button">Set</button>
        <br>
        <select id="download_option2" class="button">
          <option value="imu">IMU</option>
          <option value="gyr">Gyro</option>
          <option value="flt">Filtered</option>
          <option value="pos">Position</option>
          <option value="quat">Quaternion</option>
          <option value="euler">Euler</option>
        </select>
        <button id="download2" class="button">Download</button>

    </div>
    <hr>
    <div class="footer margin">
      For more information, see <a href="https://github.com/tomida/imu-controller" target="_blank">GitHub</a>!
    </div>
</div>
<script>
//--------------------------------------------------
//global variables
//--------------------------------------------------
//generate an instance
let ble = new BlueJelly();
let ble2 = new BlueJelly();

// read data
let read_data = '';
let read_data2 = '';
//--------------------------------------------------
//constants
//--------------------------------------------------

// characteristic uuid name
const notify_name = "[INDICATE]"; // Characteristics UUID for NOTIFY/INDICATE
const write_name = "[WRITE]"; // Characteristics UUID for WRITE
// service uuid
const service_uuid = "d68c0001-a21b-11e5-8cb8-0002a5d5c51b";
// characteristic uuid
const indicate_uuid = "d68c0002-a21b-11e5-8cb8-0002a5d5c51b";
const write_uuid = "d68c0003-a21b-11e5-8cb8-0002a5d5c51b";
const start_command = new TextEncoder("utf-8").encode('start\n');
const calc_command = new TextEncoder("utf-8").encode('calc\n');

//--------------------------------------------------
//after loading
//--------------------------------------------------
window.onload = function () {
  ble.setUUID(notify_name, service_uuid, indicate_uuid);
  ble.setUUID(write_name, service_uuid, write_uuid);
  ble2.setUUID(notify_name, service_uuid, indicate_uuid);
  ble2.setUUID(write_name, service_uuid, write_uuid);
  //initial messages
  document.getElementById('device_name').innerHTML  = "No Device";
  document.getElementById('uuid_name').innerHTML    = "Not Connected";
  document.getElementById('status').innerHTML       = "Ready";
  document.getElementById('device_name2').innerHTML  = "No Device";
  document.getElementById('uuid_name2').innerHTML    = "Not Connected";
  document.getElementById('status2').innerHTML       = "Ready";
}


//--------------------------------------------------
//after connectGATT
//--------------------------------------------------
ble.onConnectGATT = function (uuid) {
  console.log('> Connected GATT!');
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "Connected GATT!";
}
ble2.onConnectGATT = function (uuid) {
  console.log('> Connected GATT!');
  document.getElementById('uuid_name2').innerHTML = uuid;
  document.getElementById('status2').innerHTML = "Connected GATT!";
}


//--------------------------------------------------
//when Disconnected
//--------------------------------------------------
ble.onDisconnect = function() {
  document.getElementById('uuid_name').innerHTML = "Not Connected";
  document.getElementById('status').innerHTML = "Disconnected";
}
ble2.onDisconnect = function() {
  document.getElementById('uuid_name2').innerHTML = "Not Connected";
  document.getElementById('status2').innerHTML = "Disconnected";
}


//--------------------------------------------------
//after reset
//--------------------------------------------------
ble.onReset = function() {
  document.getElementById('device_name').innerHTML = "No Device";
  document.getElementById('uuid_name').innerHTML = "Not Connected";
  document.getElementById('status').innerHTML = "Cleared";
}
ble2.onReset = function() {
  document.getElementById('device_name2').innerHTML = "No Device";
  document.getElementById('uuid_name2').innerHTML = "Not Connected";
  document.getElementById('status2').innerHTML = "Cleared";
}

//--------------------------------------------------
//after error
//--------------------------------------------------
ble.onError = function(error){
  document.getElementById('status').innerHTML = "ERROR: " + error;
}
ble2.onError = function(error){
  document.getElementById('status2').innerHTML = "ERROR: " + error;
}

//--------------------------------------------------
//after writing
//--------------------------------------------------
ble.onWrite = function(uuid){
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "written data"
}
ble2.onWrite = function(uuid){
  document.getElementById('uuid_name2').innerHTML = uuid;
  document.getElementById('status2').innerHTML = "written data"
}

//--------------------------------------------------
//after reading
//--------------------------------------------------
ble.onRead = function (data, uuid){
  //decode data from a device
  const decoded_data = (new TextDecoder('utf-8')).decode(data);
  //display the value in console
  console.log(decoded_data);
  read_data += decoded_data;
  if((read_data.match("OK") || read_data.match("ERROR")) && read_data.match(":")){ // todo 末尾でマッチ
    const blob = new Blob([read_data], {type: "text/plain"}); // binary data
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.target = '_blank';
    a.download = `${document.getElementById('download_option').value}_output.txt`;
    a.click();
    read_data = '';
    URL.revokeObjectURL(a.href); // discharge object URL
    document.getElementById('data_text').innerHTML = "Downloaded";
  }
  else if(read_data.match("OK") || read_data.match("ERROR")){  //display the value in html
    document.getElementById('data_text').innerHTML = read_data;
    read_data = '';
  }else{
    document.getElementById('data_text').innerHTML = "Downloading";
  }
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "read data"
}
ble2.onRead = function (data, uuid){
  //decode data from 2nd device
  const decoded_data2 = (new TextDecoder('utf-8')).decode(data);
  //display the value in console
  console.log(decoded_data2);
  read_data2 += decoded_data2;
  if((read_data2.match("OK") || read_data2.match("ERROR"))  && read_data2.match(":")){ // todo 末尾でマッチ
    const blob = new Blob([read_data2], {type: "text/plain"}); // binary data
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.target = '_blank';
    a.download = `${document.getElementById('download_option2').value}_output.txt`;
    a.click();
    read_data2 = '';
    URL.revokeObjectURL(a.href); // discharge object URL
    document.getElementById('data_text2').innerHTML = "Downloaded";
  }
  else if(read_data2.match("OK") || read_data2.match("ERROR")){  //display the value in html
    document.getElementById('data_text2').innerHTML = read_data2;
    read_data2 = '';
  }else{
    document.getElementById('data_text2').innerHTML = "Downloading";
  }
  document.getElementById('uuid_name2').innerHTML = uuid;
  document.getElementById('status2').innerHTML = "read data"
}

//-------------------------------------------------
//Event listener when buttons are clicked
//--------------------------------------------------
//start Measuring in all devices
document.getElementById('start_all').addEventListener('click', function() {
  console.log("start all");
  document.getElementById('data_text').innerHTML = "Measuring";
  document.getElementById('data_text2').innerHTML = "Measuring";
  ble.write(write_name, start_command);
  ble2.write(write_name, start_command);
});
//calculation in all devices
document.getElementById('calc_all').addEventListener('click', function() {
  console.log("calculate in all");
  document.getElementById('data_text').innerHTML = "Calculating";
  document.getElementById('data_text2').innerHTML = "Calculating";
  ble.write(write_name, calc_command);
  ble2.write(write_name, calc_command);
});

//start indication
document.getElementById('startNotifications').addEventListener('click', function() {
  document.getElementById('data_text').innerHTML = "";
  document.getElementById('device_name').innerHTML  = "No Device";
  document.getElementById('uuid_name').innerHTML    = "Not Connected";
  document.getElementById('status').innerHTML       = "Ready";
  ble.reset(); //reset is disconnect & clear
  ble.startNotify(notify_name);
  read_data = ''
});
document.getElementById('startNotifications2').addEventListener('click', function() {
  document.getElementById('data_text2').innerHTML = "";
  document.getElementById('device_name2').innerHTML  = "No Device";
  document.getElementById('uuid_name2').innerHTML    = "Not Connected";
  document.getElementById('status2').innerHTML       = "Ready";
  ble2.reset(); //reset is disconnect & clear
  ble2.startNotify(notify_name);
  read_data2 = ''
});

//start
document.getElementById('start').addEventListener('click', function() {
  console.log("start 1");
  document.getElementById('data_text').innerHTML = "Measuring";
  ble.write(write_name, start_command);
});
document.getElementById('start2').addEventListener('click', function() {
  console.log("start 2");
  document.getElementById('data_text2').innerHTML = "Measuring";
  ble2.write(write_name, start_command);
});

// calc
document.getElementById('calc').addEventListener('click', function() {
  console.log("calculate in 1");
  document.getElementById('data_text').innerHTML = "Calculating";
  ble.write(write_name, calc_command);
});
document.getElementById('calc2').addEventListener('click', function() {
  console.log("calculate in 2");
  document.getElementById('data_text2').innerHTML = "Calculating";
  ble2.write(write_name, calc_command);
});

// get parameter settings
document.getElementById('get').addEventListener('click', function() {
  const param = document.getElementById('parameter').value;
  console.log(`get ${param} from 1`);
  const data = new TextEncoder("utf-8").encode(`get ${param}\n`);
  ble.write(write_name, data);
});
document.getElementById('get2').addEventListener('click', function() {
  const param = document.getElementById('parameter2').value;
  console.log(`get ${param} from 2`);
  const data = new TextEncoder("utf-8").encode(`get ${param}\n`);
  ble2.write(write_name, data);
});

// set parameter
document.getElementById('set').addEventListener('click', function() {
  const param = document.getElementById('parameter').value;
  const _value = document.getElementById('_value').value;
  console.log(`set ${param} ${_value} for 1\n`);
  const data = new TextEncoder("utf-8").encode(`set ${param} ${_value}\n`);
  ble.write(write_name, data);
});
document.getElementById('set2').addEventListener('click', function() {
  const param = document.getElementById('parameter2').value;
  const _value = document.getElementById('_value2').value;
  console.log(`set ${param} ${_value} for 2\n`);
  const data = new TextEncoder("utf-8").encode(`set ${param} ${_value}\n`);
  ble2.write(write_name, data);
});

// download
document.getElementById('download').addEventListener('click', function() {
  const option = document.getElementById('download_option').value;
  console.log(`download ${option} from 1`);
  document.getElementById('data_text').innerHTML = "Downloading";
  const data = new TextEncoder("utf-8").encode(`download ${option}\n`);
  ble.write(write_name, data);
});
document.getElementById('download2').addEventListener('click', function() {
  const option = document.getElementById('download_option2').value;
  console.log(`download ${option} from 2`);
  document.getElementById('data_text2').innerHTML = "Downloading";
  const data = new TextEncoder("utf-8").encode(`download ${option}\n`);
  ble2.write(write_name, data);
});

</script>
</body>
</html>
