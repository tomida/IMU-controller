<!doctype html>
<!--
Copyright 2019 Yu Tomida. All Rights Reserved.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="GAIT">
    <meta name="viewport" content="width=800, maximum-scale=1.0, user-scalable=yes">
    <title>GAIT</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="bluejelly.js"></script>
  </head>

<body>
<div class="container">
    <div class="title margin">
        <p id="title">IMU Controller</p>
    </div>

    <div class="contents margin">
        Push 'Get UUID'  before 'start Notify'<br>
        <button id="getUUID" class="button">Get UUID</button>
        <button id="startNotifications" class="button">Start Notify</button>
        <button id="reset" class="button">Reset</button>
        <button id="start" class="button">Start</button>
        <button id="calc" class="button">Calc</button>
        <hr>
        <div id="device_name"> </div>
        <div id="uuid_name"> </div>
        <div id="data_text"> </div>
        <div id="status"> </div>
        <select id="parameter" class="button">
          <option value="size">size</option>
          <option value="acc_th">acc_th</option>
          <option value="init_period">init_period</option>
        </select>
        <button id="get" class="button">Get</button>
        <input id='_value' type='number' class="button" value='1' size="4">
        <button id="set" class="button">Set</button>
        <br>
        <select id="download option" class="button">
          <option value="imu">IMU</option>
          <option value="gyr">Gyro</option>
          <option value="flt">Filtered</option>
          <option value="pos">Position</option>
          <option value="quat">Quaternion</option>
          <option value="euler">Euler</option>
        </select>
        <button id="download" class="button">Download</button>

    </div>
    <div class="footer margin">
      For more information, see <a href="https://github.com/tomida/imu-controller" target="_blank">GitHub</a>!
    </div>
</div>
<script>
//--------------------------------------------------
//global variable
//--------------------------------------------------
//generate an instance
var ble = new BlueJelly();
// read data
var read_data = ''
var uuid_list = []
var read_uuid
var write_uuid
//--------------------------------------------------
//after loading
//--------------------------------------------------
window.onload = function () {
  //initial messages
  document.getElementById('device_name').innerHTML  = "No Device";
  document.getElementById('uuid_name').innerHTML    = "Not Connected";
  document.getElementById('status').innerHTML       = "ready";
}


//--------------------------------------------------
//after scanning
//--------------------------------------------------
ble.onScan = function (deviceName) {
  console.log('> Bluetooth Device found!');

  document.getElementById('device_name').innerHTML = deviceName;
  document.getElementById('status').innerHTML = "found device!";
}


//--------------------------------------------------
//after connectGATT
//--------------------------------------------------
ble.onConnectGATT = function (uuid) {
  console.log('> connected GATT!');
  uuid_list.push(uuid)
  write_uuid = uuid_list.find(function(uuid){
    return uuid.match(/.*WRITE.*/)
  })
  read_uuid = uuid_list.find(function(uuid){
    return uuid.match(/.*(INDICATE|READ).*/)
  })
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "connected GATT!";
}


//--------------------------------------------------
//when disconnected
//--------------------------------------------------
ble.onDisconnect = function() {
  document.getElementById('uuid_name').innerHTML = "Not Connected";
  document.getElementById('status').innerHTML = "disconnected";
}


//--------------------------------------------------
//when cleared
//--------------------------------------------------
ble.onClear = function() {
  document.getElementById('device_name').innerHTML = "No Device";
  document.getElementById('status').innerHTML = "cleared";
}


//--------------------------------------------------
//after reset
//--------------------------------------------------
ble.onReset = function() {
  document.getElementById('device_name').innerHTML = "No Device";
  document.getElementById('uuid_name').innerHTML = "Not Connected";
  document.getElementById('status').innerHTML = "cleared";
}

//--------------------------------------------------
//after error
//--------------------------------------------------
ble.onError = function(error){
  document.getElementById('status').innerHTML = "ERROR : " + error;
}

//--------------------------------------------------
//after writing
//--------------------------------------------------
ble.onWrite = function(uuid){
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "written data"
}

//--------------------------------------------------
//after reading
//--------------------------------------------------
ble.onRead = function (data, uuid){
  //decode data from a device
  decoded_data = (new TextDecoder('utf-8')).decode(data)
  //display the value in console
  console.log(decoded_data);
  read_data += decoded_data
  // if(read_data.match("OK") && ((read_data.match(":")||[]).length > 2)){
  if(read_data.match("OK") && read_data.match(":")){
    const blob = new Blob([read_data], {type: "text/plain"}); // binary data
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.target = '_blank';
    a.download = `${document.getElementById('download option').value}_output.txt`;
    a.click();
    read_data = '';
    URL.revokeObjectURL(a.href); // オブジェクトURLを開放
  }
  else if(read_data.match("OK") || read_data.match("ERROR")){  //display the value in html
    document.getElementById('data_text').innerHTML = read_data.replace("OK", "");
    read_data = '';
  }
  document.getElementById('uuid_name').innerHTML = uuid;
  document.getElementById('status').innerHTML = "read data"
}


//-------------------------------------------------
//Event listener when buttons are clicked
//--------------------------------------------------
document.getElementById('getUUID').addEventListener('click', function(){
    ble.getUUID();
});

document.getElementById('startNotifications').addEventListener('click', function() {
    ble.startNotify(read_uuid);
    read_data=''
});

document.getElementById('reset').addEventListener('click', function() {
    ble.reset(); //reset is disconnect & clear
    read_data=''
});
//start
document.getElementById('start').addEventListener('click', function() {
    const data = new TextEncoder("utf-8").encode('start\n');
    ble.write(write_uuid, data);
});
// calc
document.getElementById('calc').addEventListener('click', function() {
    const data = new TextEncoder("utf-8").encode('calc\n');
    ble.write(write_uuid, data);
});
// get parameter settings
document.getElementById('get').addEventListener('click', function() {
    const option = document.getElementById('parameter').value;
    console.log(`get ${option}\n`)
    const data = new TextEncoder("utf-8").encode(`get ${option}\n`);
    ble.write(write_uuid, data);
});

// set parameter
document.getElementById('set').addEventListener('click', function() {
    const param = document.getElementById('parameter').value;
    const _value = document.getElementById('_value').value;
    console.log(`set ${param} ${_value}\n`)
    const data = new TextEncoder("utf-8").encode(`set ${param} ${_value}\n`);
    ble.write(write_uuid, data);
});

// download
document.getElementById('download').addEventListener('click', function() {
    const option = document.getElementById('download option').value;
    console.log(`download ${option}\n`)
    const data = new TextEncoder("utf-8").encode(`download ${option}\n`);
    ble.write(write_uuid, data);
});

</script>
</body>
</html>
